@startuml DataMigrationProcess

' Enable SVG animation
!pragma svganimated true

' Enable arrow animation using autonumber
autonumber

skinparam titleBorderRound 15
skinparam titleBorderThickness 2
skinparam titleBorderColor red
skinparam titleBackgroundColor white
skinparam FontName "Verdana" 

' Arrow styling for animation effect
skinparam ArrowColor DeepSkyBlue
skinparam ArrowThickness 2

title Data Migration Process Flow \n CAPS To PAT Migration Process

actor User
participant "Main Program" as Main
participant "Helper" as Helper
participant "ServiceProvider" as ServiceProvider

User -[#blue,bold]-> Main : Start with args
activate Main

Main -[#blue,bold,dashed]-> Main : Create ParameterInfo
alt ShowHelp is true
    Main -[#green,bold]-> User : Return Success
end

Main -[#blue,bold]-> ServiceProvider : AppSetup(IsBenchmark, EnvironmentName, OnlyPreRenewal)
activate ServiceProvider

Main -[#blue,bold,dashed]-> Main : Set executionGuid
Main -[#blue,bold,dashed]-> Main : Get FullRunLogger
Main -[#blue,bold]-> ServiceProvider : Get Helper service
activate Helper

Main -[#orange,bold]-> Helper : Step_NotifyBenchmarkIfApplicable
Main -[#orange,bold]-> Helper : Step_NotifyEnvironment
Main -[#orange,bold]-> Helper : Step_LogAzureConnectionDetails

alt Getpolicymigrationreport is true
    Main -[#orange,bold]-> Helper : Step_CreatePolicyMigrationReport
    Main -[#orange,bold]-> Helper : Step_CreateHupeMigrationWeeklyReport
    Main -[#green,bold]-> User : Return Success
end

Main -[#orange,bold]-> Helper : Step_PerformETLProcess
Helper -[#purple,bold,dashed]-> Main : Return ETL data
Main -[#blue,bold,dashed]-> Main : Store AgencyPoliciesFromCaps

Main -[#orange,bold]-> Helper : Step_NotifyFullExtractionReport
Main -[#orange,bold]-> Helper : Step_CreateFullExtractionReportByAgencyOrPolicyNumbers (async)

alt ETLDone is true
    Main -[#orange,bold]-> Helper : Step_GetPoliciesToETL
    activate Helper
    Helper -[#purple,bold,dashed]-> Main : Return etlPolicies
    deactivate Helper
    
    Main -[#orange,bold]-> Helper : Step_RunValidation_WhenParameterIsOn
    Main -[#orange,bold]-> Helper : Step_CheckPoliciesAgainstTheAllowedSet
    Helper -[#purple,bold,dashed]-> Main : Return filtered etlPolicies
    Main -[#orange,bold]-> Helper : Step_PassPrerenewalFlagForAllConsumersSoThatTheyAreAware
    
    alt RunIssuesToResolveValidation is true
        Main -[#orange,bold]-> Helper : Step_RunIssuesToResolveValidation
        Main -[#green,bold]-> User : Return Success
    end
      Main -[#orange,bold]-> Helper : Step_RunIssuesToResolveValidation_WhenFlagsAllow
    Main -[#orange,bold]-> Helper : Step_CompareNumberOfPoliciesTransactionCountsByLOB
    Main -[#orange,bold]-> Helper : Step_CreateExecutionStatus_WhenAllowed
    Main -[#orange,bold]-> Helper : Step_LogFinalSuccessMessage
else ETLDone is false
    Main -[#red,bold]-> Helper : Step_LogErrorForPreRenewalPolicies
end

Main -[#orange,bold]-> Helper : Step_DeleteTemporaryFilesFromMigrationProcess
Main -[#orange,bold]-> Helper : Step_ProcessDailyValidationRun
Main -[#orange,bold]-> Helper : Await step_completeFullExtractionReportTask

deactivate Helper
deactivate ServiceProvider

Main -[#green,bold]-> User : Return Success

note right of Main
  Exception handling:
  If any exception occurs during the process,
  it will be published via ExceptionPublisher,
  logged, and Error exit code will be returned
end note

@enduml